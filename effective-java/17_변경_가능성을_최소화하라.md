### 불변 객체

- 그 인스턴스의 내부 값을 수정할 수 없는 클래스
- 불변 인스턴스에 간직된 정보는 고정되어 객체가 소멸되는 순간까지 절대 달라지지 않는다.
- 자바 라이브러리에는 다음과 같은 다양한 불변 클래스가 있다. (String, Integer, BigDecimal, ...)

> 왜 이 클래스들을 '불변'으로 설계한 걸까?<br/>
> 불변 클래스는 가변 클래스보다 설계/구현/사용에 용이하며 오류가 생길 여지가 적고 훨씬 안전하다.

클래스를 불변 클래스로 만들려면 다섯 가지 규칙을 따르면 된다.

> 1. 객체의 상태를 변경하는 메서드(변경자)를 제공하지 않는다.<br/>
> 2. 클래스를 확장할 수 없도록 한다.<br/>
> 3. 모든 필드를 final로 선언한다.<br/>
> 4. 모든 필드를 private으로 선언한다.<br/>
> 5. 자신 외에는 내부의 가변 컴포넌트에 접근할 수 없도록 한다.<br/>

하나씩 차근히 알아보자.

<br/>

1. 객체의 상태를 변경하는 메서드(변경자)를 제공하지 않는다.

여기서 말하는 '상태를 변경하는 메서드'는 setter를 의미한다.<br/>
다시 말해 아래의 클래스에는 setter가 존재하므로 불변 객체가 아니다.

```java
public class Time {
    private int hour; // 시
    private int minute; // 분
    private int second; // 초
    
    public void setHour(int hour) {
        this.hour = hour;
    }
    
    public void setMinute(int minute) {
        this.minute = minute;
    }
    
    public void setSecond(int second) {
        this.second = second;
    }
    ...
}
```

<br/>

2. 클래스를 확장할 수 없도록 한다.

확장의 의미는 상속을 가리키며 하위 클래스에서 부주의하게 객체의 상태를 변하게 만드는 사태를 막아준다.<br/>
클래스의 상속을 막는  방법은 `final`로 선언하는 것이다.

```java
public final class Time {...}
```

<br/>

3. 모든 필드를 `final`로 선언한다.

- 여러 스레드에서 접근해도 문제없이 동작하게끔 보장해준다. 즉, 다중 스레드 환경에서도 안전하다.

<br/>

4. 모든 필드를 `private`으로 선언한다.

가변 객체를 참조하더라도 이를 외부에서 직접 접근하여 수정하지는 못한다.<br/>
public final로만 선언해도 불변 객체가 되지만 권장하지는 않는다. (item 15, 16)

<br/>

5. 자신 외에는 내부의 가변 컴포넌트에 접근할 수 없도록 한다.

클래스가 가변 객체를 참조하는 필드가 존재한다면 클라이언트에서 그 객체의 참조를 얻을 수 없도록 해야 한다.<br/>
생성자, 접근자, readObject 메서드 모두에서 방어적 복사를 수행하라. (item 88)

```java
public class Printer {
    private final List<Paper> papers;
    
    public Printer(List<Paper> papers) {
        this.papers = List.copyOf(papers);
    }
    
    public List<Paper> getPapers() {
        return Collection.unmodifiableList(papers);
    }
}
```

### 불변 객체는 근본적으로 thread-safe하며 동기화할 필요가 없다.

여러 스레드가 접근해도 불변 객체이므로 안심하고 공유할 수 있다.<br/>
따라서 불변 클래스라면 한 번 만든 인스턴스를 최대한 재활용하는 것을 권장한다.

가장 쉬운 재활용 방법은 자주 쓰이는 값들을 상수로 제공하는 것이다.
```java
public static final Complex ZERO = new Complex(0, 0);
public static final Complex ONE = new Complex(1, 0);
```
```java
// static 초기화 블럭
public class StaticBlock {
    static final Map<Integer, String> immutableMap;
    
    static {
        Map<Integer, String> mutableMap = new HashMap<>();
        mutableMap.put(1, "one");
        mutableMap.put(2, "two");
        immutableMap = Collections.unmodifiableMap(mutableMap);
    }
    ...
}
```

